---
title: "prevR Survival Vignette"
author: "Stephanie J. Lax"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{prevR Vignette Comp}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This document tests the ability of the prevR package to predict survival from a synthetic patient dataset. 

```{r backgroundsetup, echo = FALSE, message = FALSE, warning = FALSE}
library(devtools)
devtools::load_all()

library(abind)
library(dplyr)
library(rms)
library(survival)

load("../data/registry_data.rda")

registry_years <- c("2004-09-01", "2005-09-01", "2006-09-01", "2007-09-01", "2008-09-01",
                    "2009-09-01", "2010-09-01", "2011-09-01", "2012-09-01", "2013-09-01")
registry_start_year <- 2
registry_end_year <- 9
cure <- 3
```

## Survival Modelling

### Diagnostics

Total Cases:

```{r survtest, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
survival_modelling_diagnostics(load_data(registry_data), ages = c(55, 65, 75, 85, 100), 
                               registry_years, registry_start_year, registry_end_year)
```

```{r survivalTEST, echo = FALSE, fig.show="hide"}
output <- survival_modelling_diagnostics(load_data(registry_data), ages = c(55, 65, 75, 85, 100), 
                               registry_years, registry_start_year, registry_end_year)
output[[5]]
```

Males:

```{r survtest2, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
survival_modelling_diagnostics(load_data(registry_data, sex = "Males"), ages = c(55, 65, 75, 85, 100), 
                               registry_years, registry_start_year, registry_end_year)
```

```{r survivalTEST2, echo = FALSE, fig.show="hide"}
output <- survival_modelling_diagnostics(load_data(registry_data, sex = "Males"), ages = c(55, 65, 75, 85, 100), 
                               registry_years, registry_start_year, registry_end_year)
output[[5]]
```

Females:

```{r survtest3, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
survival_modelling_diagnostics(load_data(registry_data, sex = "Females"), ages = c(55, 65, 75, 85, 100), 
                               registry_years, registry_start_year, registry_end_year)
```

```{r survivalTEST3, echo = FALSE, fig.show="hide"}
output <- survival_modelling_diagnostics(load_data(registry_data, sex = "Females"), ages = c(55, 65, 75, 85, 100), 
                               registry_years, registry_start_year, registry_end_year)
output[[5]]
```

Adults:

```{r survtest4, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
survival_modelling_diagnostics(load_data(registry_data, age_division = "Adult", 
                                         age_cut = 20), ages = c(55, 65, 75, 85, 100), 
                               registry_years, registry_start_year, registry_end_year)
```

```{r survivalTEST4, echo = FALSE, fig.show="hide"}
output <- survival_modelling_diagnostics(load_data(registry_data, age_division = "Adult", 
                                         age_cut = 20), ages = c(55, 65, 75, 85, 100), 
                               registry_years, registry_start_year, registry_end_year)
output[[5]]
```

Paediatrics:

```{r survtest5, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
survival_modelling_diagnostics(load_data(registry_data, age_division = "Paediatric", 
                                         age_cut = 20), ages = c(0, 5, 10, 15, 20), 
                               registry_years, registry_start_year, registry_end_year)
```

```{r survivalTEST5, echo = FALSE, fig.show="hide"}
output <- survival_modelling_diagnostics(load_data(registry_data, age_division = "Paediatric", 
                                                   age_cut = 20), ages = c(0, 5, 10, 15, 20), 
                                         registry_years, registry_start_year, registry_end_year)
output[[5]]
```

Paediatric Males:

Too few incident cases.

Paediatric Females:

```{r survtest7, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
survival_modelling_diagnostics(load_data(registry_data, age_division = "Paediatric", 
                                         age_cut = 20, sex = "Females"), ages = c(0, 5, 10, 15, 20), 
                               registry_years, registry_start_year, registry_end_year)
```

```{r survivalTEST7, echo = FALSE, fig.show="hide"}
output <- survival_modelling_diagnostics(load_data(registry_data, age_division = "Paediatric", 
                                         age_cut = 20, sex = "Females"), ages = c(0, 5, 10, 15, 20), 
                               registry_years, registry_start_year, registry_end_year)
output[[5]]
```

### Check Functional Form of Age:

```{r ageform2, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
age_fform <- functional_form_age(load_data(registry_data), registry_years, 
                                 registry_start_year, registry_end_year)
age_fform[[2]]
age_fform[[3]]
age_fform[[4]]
age_fform[[5]]
```

### Preparing Population Survival Data

```{r popsurv3, fig.width = 6, fig.height = 4, error = TRUE}
load("../data/population_data_mx.rda")

daily_survival_rate_males <- daily_survival_rate(population_data_mx, sex = "MMles")
daily_survival_rate_males <- daily_survival_rate(population_data_mx, sex = "Males")
daily_survival_males <- cumprod(1 - daily_survival_rate_males)

daily_survival_rate_females <- daily_survival_rate(population_data_mx, sex = "Females")
daily_survival_females <- cumprod(1 - daily_survival_rate_females)

par(mfrow=c(1,1))
plot(daily_survival_males, type="l", col="blue", xlab="days", ylab="survival")
lines(daily_survival_females, col="red")
legend("topright", legend = c("Males", "Females"),
               bty = "n", lty = 1, col = c(4,2))
```

### Weibull Modelling

```{r weibull, fig.width = 7, fig.height = 7, error = TRUE}
registry_data_r <- load_data(registry_data)
registry_data_r <- registry_data_r[registry_data_r$date_initial >= 
                                     registry_years[registry_start_year], ]

wb <- survreg(Surv(survival_time, indicator) ~ age_initial + sex, data=registry_data_r)
summary(wb)

par(mfrow=c(2,2))
pct <- 1:98/100
wbp <- predict(wb, newdata=data.frame(age_initial=70, sex=0), type="quantile", p=pct)
plot(wbp, 1-pct, lwd=2, col="blue", main = "Adult Male", type="l", xlim=c(0,3000))
cx <- coxph(Surv(survival_time, indicator) ~ age_initial + sex, data=registry_data_r)
cxp <- survfit(cx, newdata=data.frame(age_initial=70, sex=0))
lines(cxp, lwd=2, col="green", mark.time=F)

pct <- 1:98/100
wbp <- predict(wb, newdata=data.frame(age_initial=70, sex=0), type="quantile", p=pct, se.fit=T)
plot(wbp$fit, 1-pct, lwd=2, col="blue", type="l", xlim=c(0,3000))
lines(wbp$fit + 1.96*wbp$se.fit, 1-pct, lwd=2, col="blue", lty=2)
lines(wbp$fit - 1.96*wbp$se.fit, 1-pct, lwd=2, col="blue", lty=2)

pct <- 1:98/100
wbp <- predict(wb, newdata=data.frame(age_initial=70, sex=1), type="quantile", p=pct)
plot(wbp, 1-pct, lwd=2, col="blue", main = "Adult Female", type="l", xlim=c(0,3000))
cx <- coxph(Surv(survival_time, indicator) ~ age_initial + sex, data=registry_data_r)
cxp <- survfit(cx, newdata=data.frame(age_initial=70, sex=1))
lines(cxp, lwd=2, col="green", mark.time=F)

pct <- 1:98/100
wbp <- predict(wb, newdata=data.frame(age_initial=70, sex=1), type="quantile", p=pct, se.fit=T)
plot(wbp$fit, 1-pct, lwd=2, col="blue", type="l", xlim=c(0,3000))
lines(wbp$fit + 1.96*wbp$se.fit, 1-pct, lwd=2, col="blue", lty=2)
lines(wbp$fit - 1.96*wbp$se.fit, 1-pct, lwd=2, col="blue", lty=2)

pct <- 1:98/100
wbp <- predict(wb, newdata=data.frame(age_initial=10, sex=0), type="quantile", p=pct)
plot(wbp, 1-pct, lwd=2, col="blue", main = "Paediatric Male", type="l", xlim=c(0,3000))
cx <- coxph(Surv(survival_time, indicator) ~ age_initial + sex, data=registry_data_r)
cxp <- survfit(cx, newdata=data.frame(age_initial=10, sex=0))
lines(cxp, lwd=2, col="green", mark.time=F)

pct <- 1:98/100
wbp <- predict(wb, newdata=data.frame(age_initial=10, sex=0), type="quantile", p=pct, se.fit=T)
plot(wbp$fit, 1-pct, lwd=2, col="blue", type="l", xlim=c(0,3000))
lines(wbp$fit + 1.96*wbp$se.fit, 1-pct, lwd=2, col="blue", lty=2)
lines(wbp$fit - 1.96*wbp$se.fit, 1-pct, lwd=2, col="blue", lty=2)

pct <- 1:98/100
wbp <- predict(wb, newdata=data.frame(age_initial=10, sex=1), type="quantile", p=pct)
plot(wbp, 1-pct, lwd=2, col="blue", main = "Paediatric Female", type="l", xlim=c(0,3000))
cx <- coxph(Surv(survival_time, indicator) ~ age_initial + sex, data=registry_data_r)
cxp <- survfit(cx, newdata=data.frame(age_initial=10, sex=1))
lines(cxp, lwd=2, col="green", mark.time=F)

pct <- 1:98/100
wbp <- predict(wb, newdata=data.frame(age_initial=10, sex=1), type="quantile", p=pct, se.fit=T)
plot(wbp$fit, 1-pct, lwd=2, col="blue", type="l", xlim=c(0,3000))
lines(wbp$fit + 1.96*wbp$se.fit, 1-pct, lwd=2, col="blue", lty=2)
lines(wbp$fit - 1.96*wbp$se.fit, 1-pct, lwd=2, col="blue", lty=2)
```

## Hazard and Survival Functions

### Adults:

```{r weibull2, fig.width = 7, fig.height = 7, error = TRUE}
#Need to rewrite these functions and their subroutines to ensure they're correct
#dfr_sh <- 1/wb$scale

#par(mfrow=c(2,2))
#plot_haz(60, "Male", 3000, wb)
#plot_pop_haz(population_data_mx, 60, "Male", 3000)
#plot_haz(60, "Female", 3000, wb)
#plot_pop_haz(population_data_mx, 60, "Female", 3000)

#plot_haz(70, "Male", 3000, wb)
#plot_pop_haz(population_data_mx, 70, "Male", 3000)
#plot_haz(70, "Female", 3000, wb)
#plot_pop_haz(population_data_mx, 70, "Female", 3000)

#plot_haz(80, "Male", 3000, wb)
#plot_pop_haz(population_data_mx, 80, "Male", 3000)
#plot_haz(80, "Female", 3000, wb)
#plot_pop_haz(population_data_mx, 80, "Female", 3000)

#plot_haz(90, "Male", 3000, wb)
#plot_pop_haz(population_data_mx, 90, "Male", 3000)
#plot_haz(90, "Female", 3000, wb)
#plot_pop_haz(population_data_mx, 90, "Female", 3000)

#plot_Su(60, "Male", 3000, wb)
#plot_pop_Su(population_data_mx, 60, "Male", 3000)
#plot_km(load_data(registry_data), registry_years, registry_start_year, 60, "Male", 4)
#plot_Su(60, "Female", 3000, wb)
#plot_pop_Su(population_data_mx, 60, "Female", 3000)
#plot_km(prelim, years_of, startyear = year1, 60, "Female", 4)

#plot_Su(70, "Male", 3000, wb)
#plot_pop_Su(population_data_mx, 70, "Male", 3000)
#plot_km(prelim, years_of, startyear = year1, 70, "Male", 4)
#plot_Su(70, "Female", 3000, wb)
#plot_pop_Su(population_data_mx, 70, "Female", 3000)
#plot_km(prelim, years_of, startyear = year1, 70, "Female", 4)

#plot_Su(80, "Male", 3000, wb)
#plot_pop_Su(population_data_mx, 80, "Male", 3000)
#plot_km(prelim, years_of, startyear = year1, 80, "Male", 4)
#plot_Su(80, "Female", 3000, wb)
#plot_pop_Su(population_data_mx, 80, "Female", 3000)
#plot_km(prelim, years_of, startyear = year1, 80, "Female", 4)

#plot_Su(90, "Male", 3000, wb)
#plot_pop_Su(population_data_mx, 90, "Male", 3000)
#plot_km(prelim, years_of, startyear = year1, 90, "Male", 4)
#plot_Su(90, "Female", 3000, wb)
#plot_pop_Su(population_data_mx, 90, "Female", 3000)
#plot_km(prelim, years_of, startyear = year1, 90, "Female", 4)
```

### Paediatrics:

```{r weibull3, fig.width = 7, fig.height = 7, error = TRUE}
#par(mfrow=c(2,2))
#plot_haz(2, "Male", 3000, wb)
#plot_pop_haz(population_data_mx, 2, "Male", 3000)
#plot_haz(2, "Female", 3000, wb)
#plot_pop_haz(population_data_mx, 2, "Female", 3000)

#plot_haz(5, "Male", 3000, wb)
#plot_pop_haz(population_data_mx, 5, "Male", 3000)
#plot_haz(5, "Female", 3000, wb)
#plot_pop_haz(population_data_mx, 5, "Female", 3000)

#plot_haz(10, "Male", 3000, wb)
#plot_pop_haz(population_data_mx, 10, "Male", 3000)
#plot_haz(10, "Female", 3000, wb)
#plot_pop_haz(population_data_mx, 10, "Female", 3000)

#plot_haz(15, "Male", 3000, wb)
#plot_pop_haz(population_data_mx, 15, "Male", 3000)
#plot_haz(15, "Female", 3000, wb)
#plot_pop_haz(population_data_mx, 15, "Female", 3000)

#plot_Su(2, "Male", 3000, wb)
#plot_pop_Su(population_data_mx, 2, "Male", 3000)
#plot_km(prelim, years_of, startyear = year1, 2, "Male", 4)
#plot_Su(2, "Female", 3000, wb)
#plot_pop_Su(population_data_mx, 2, "Female", 3000)
#plot_km(prelim, years_of, startyear = year1, 2, "Female", 4)

#plot_Su(5, "Male", 3000, wb)
#plot_pop_Su(population_data_mx, 5, "Male", 3000)
#plot_km(prelim, years_of, startyear = year1, 5, "Male", 4)
#plot_Su(5, "Female", 3000, wb)
#plot_pop_Su(population_data_mx, 5, "Female", 3000)
#plot_km(prelim, years_of, startyear = year1, 5, "Female", 4)

#plot_Su(10, "Male", 3000, wb)
#plot_pop_Su(population_data_mx, 10, "Male", 3000)
#plot_km(prelim, years_of, startyear = year1, 10, "Male", 4)
#plot_Su(10, "Female", 3000, wb)
#plot_pop_Su(population_data_mx, 10, "Female", 3000)
#plot_km(prelim, years_of, startyear = year1, 10, "Female", 4)

#plot_Su(15, "Male", 3000, wb)
#plot_pop_Su(population_data_mx, 15, "Male", 3000)
#plot_km(prelim, years_of, startyear = year1, 15, "Male", 4)
#plot_Su(15, "Female", 3000, wb)
#plot_pop_Su(population_data_mx, 15, "Female", 3000)
#plot_km(prelim, years_of, startyear = year1, 15, "Female", 4)
```

Distribution of bootstrapped survival models:

```{r weibull4, fig.width = 7, fig.height = 7, error = TRUE}
par(mfrow=c(2,2))
boot_eg(load_data(registry_data), registry_years, registry_start_year, 60, "Male")
boot_eg(load_data(registry_data), registry_years, registry_start_year, 60, "Female")
boot_eg(load_data(registry_data), registry_years, registry_start_year, 0, "Male")
boot_eg(load_data(registry_data), registry_years, registry_start_year, 0, "Female")
```
