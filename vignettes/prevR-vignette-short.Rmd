---
title: "prevR Vignette (Short)"
author: "Stephanie J. Lax"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{prevR Vignette Short}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This document demonstrates how predictions of prevalence are calculated from a synthetic patient dataset. For the purposes of this document, the term prevalence refers to estimates of point prevalence at an index date.

```{r, echo = FALSE, message = FALSE}
library(devtools)
devtools::load_all()
```

# Basic setup and summary of data

```{r setup, message = FALSE, warning = FALSE}
library(dplyr)
library(abind)
library(rms)
library(survival)
library(knitr)
library(tidyr)
library(dplyr)
data(prevsim)
num_years_to_estimate <- 10
cure <- 3

summary(prevsim)
```

The following shows the survival characteristics of the included dataset, *prevsim*:

```{r basicsurvival, fig.height=4, fig.width=7}
survf <- survfit(Surv(time, status) ~ sex, data=prevsim)
plot(survf, lwd=2, col = c(1:2), xlab="survival (days)", ylab="probability")
legend(3000, 1, c("Males", "Females"), lty = 1, col=c(1:2))
```

*prevsim* is a dataset that has been synthesised to resemble disease registry data. Incident cases are recorded from `r min(prevsim$entrydate)` to `r max(prevsim$entrydate)`, and events occur between `r min(prevsim$eventdate)` and `r max(prevsim$eventdate)`. 

## Incidence

The following code calculates absolute incidence of disease for each selected year of the registry:

```{r totalincidence, error = TRUE}
raw_incidence <- incidence(prevsim$entrydate, start="2004-01-30", 9)
raw_incidence
```

It can be concluded that the disease has around 100 new cases each year. To assess consistency of the incidence data with a homogeneous Poisson process, the `sim_check` and `smoothed_incidence` functions can be used:

```{r}
sim_check(raw_incidence)
```

```{r, fig.width = 7, fig.height = 7, include = TRUE, results="hide"}
par(mfrow=c(2,2))
c_inc <- cumulative_incidence(prevsim$entrydate, start = "2004-01-30", num_reg_years = 9)
ordered_diagnoses <- c_inc$ordered_diagnoses
smooth <- c_inc$smooth

plot(ordered_diagnoses, seq(length(ordered_diagnoses)), pch=20, 
     cex=0.7, xlab="days", ylab="cumulative diagnoses")
abline(a=0, b=length(ordered_diagnoses)/ordered_diagnoses[length(ordered_diagnoses)], 
       col="red", lwd=2)
lines(smooth, col="green", lwd=2)

plot(ordered_diagnoses, seq(length(ordered_diagnoses)) - predict(smooth, ordered_diagnoses)$y, 
     type="l", xlab="days", ylab="deviation from smooth")

inspect_incidence(c_inc)

poisson_incidence_sim(c_inc)

print.incidence(c_inc)

summary.incidence(c_inc)
```

The age distribution of incident cases can also be inspected:

```{r incidenceage, fig.width = 7, fig.height = 4, error = TRUE}
prevsim_r <- prevsim[prevsim$entrydate >= "2004-01-30", ]

incidence_age_distribution(prevsim_r$age)
```

To calculate the mean incidence rate per 100,000 within the study population `meanIR` is used, which requires an estimate of the size of the population at risk:
  
```{r incidencerate, error = TRUE}
meanIR(prevsim$entrydate, population_size = 3.5e6,
       start = "2004-01-30", num_reg_years = 9)
```

## Survival modelling

It is recommended that the user inspects the survival data for consistency between years of the registry and with a Cox Proportional Hazards model as follows:

```{r survivaldiag, fig.width = 7, fig.height = 7}
par(mfrow=c(2,2))

km <- survfit(Surv(time, status) ~ 1, data=prevsim_r)
plot(km, lwd=2, col="blue", xlab="survival (days)", ylab="probability")

ages = c(55, 65, 75, 85, 100)
km2 <- survfit(Surv(time, status) ~ cut(age, breaks=ages), data=prevsim_r)
plot(km2, lwd=2, col=1:length(ages), xlab="survival (days)", ylab="probability")

cx <- coxph(Surv(time, status) ~ age, data=prevsim_r)
cxp <- survfit(cx, 
               newdata=data.frame(age=vapply(seq(length(ages) - 1), 
                                                function(i) mean(c(ages[i], ages[i + 1])), 
                                                numeric(1))))
lines(cxp, lwd=2, col=1:length(ages), lty=2, mark.time=F)

plot(cox.zph(cx))

plot(km, lwd=2, col="blue", mark.time=F, conf.int=T, xlab="survival (days)", ylab="probability")
num_reg_years <- 9
registry_years <- determine_registry_years(start='2004-01-30', num_reg_years=num_reg_years)
sapply(seq(num_reg_years),
       function(i) lines(survfit(Surv(time, status) ~ 1, 
                                 data=prevsim_r[prevsim_r$entrydate >= 
                                                          registry_years[i] & 
                                                          prevsim_r$entrydate < 
                                                          registry_years[i + 1], ]), 
                         mark.time = F, conf.int = F))
cox.zph(cx)
```

### Functional form of age

`functional_form_age()` is provided so that the user can determine if modelling the effect of age as linear is appropriate. 

```{r ageform2, fig.width = 7, fig.height = 4, error = TRUE}
functional_form_age(Surv(time, status) ~ age(age), prevsim_r)
```

### Weibull model

We model survival in our patient cohort using a Weibull distribution. This is calculated within the prevalence function, however, it is important to look at `summary(wb)` for diagnostic information and to assess the model fit. 

```{r weibull, error = TRUE}
wb <- survreg(Surv(time, status) ~ age + sex, data=prevsim_r)
summary(wb)
```

As an alternative to extrapolation of long-term survival of patients using the Weibull model alone, we have implemented an alternative, which we call a cure model. For example, the default `cure = 10` in the following functions for estimating prevalence, means a patient can be considered "cured" if they have survived until 10 years after diagnosis, and therefore from this point onwards their survival is modelled using population data rather than patient data. 

### Population survival

General population period survival data for the UK is loaded and yearly rates are translated into daily rates by linear interpolation using `population_survival_rate()`. 

```{r popsurv, fig.width = 6, fig.height = 4, error = TRUE}
data(UKmortality)

daily_survival_males <- population_survival_rate(rate ~ age, subset(UKmortality, sex == 0))
daily_survival_females <- population_survival_rate(rate ~ age, subset(UKmortality, sex == 1))

plot(daily_survival_males, type="l", col="blue", xlab="days", ylab="survival")
lines(daily_survival_females, col="red")
legend("topright", legend = c("Males", "Females"),
               bty = "n", lty = 1, col = c(4,2))
```

## Prevalence estimates

### Counts

In the first instance, prevalence can be estimated by counting from the registry data. When doing this using the supplied synthetic dataset, it is important to note that there is a discrepency between the last recorded incident case and the last date of follow-up owing to a systematic difference in incidence and survival data collection. All the survival data for the available incident cases is used for survival modelling, however the prevalence estimate works back by year from an "index date", which is the last date of the last year of registry data, as it is imperative that the number of incident cases is complete for simulating prevalence. Therefore, `last(determine_registry_years(start='2004-01-30', num_reg_years=9))` is the index date for this synthetic dataset. In `counted_prevalence()`, all cases alive after the index date are censored. 

```{r survival, error = TRUE}
counted_prevalence(prevsim$entrydate, 
                     prevsim$eventdate, 
                     prevsim$status, 
                     start="2004-01-30", 9)
```

### Simulation

Prevalence can now be estimated using simulation by calling `prevalence()`. `num_years_to_estimate` corresponds to the number of preceding years contributing incident cases:

```{r prevalencetotal, error = TRUE}
prevalence_total <- prevalence(Surv(time, status) ~ sex(sex) + age(age) + entry(entrydate),
                               prevsim, num_years_to_estimate, cure, 
                               start='2004-01-30', num_reg_years=9)

print(prevalence_total)

summary(prevalence_total)
```

### Comparison and substitution between simulated and counted prevalence

Whether the model is predicting good numbers for the recent years for which we have data can be assessed using a chi squared test. It uses `simulated_cases`, extracted from the prevalence object, which is a vector of the estimated absolute prevalence per year of the registry:

```{r test, error = TRUE}
prev_chisq(prevalence_total)
```

### N-year prevalence with estimation of uncertainty

As a way to estimate uncertainty of our survival model, i.e. sampling variation, the prevalence function calculates bootstrapped survival coefficients. `n_year_estimates` is a function to calculate the estimated number of *n-year* prevalent cases for any *n* up to the number of years estimated in the prevalence object. Firstly, it replaces the simulated values with the observed values for the years where registry data is available. It then returns the absolute numerical estimate, an estimate of the prevalence proportion and confidence intervals for the prevalence proportion:

```{r nyrest3, error = TRUE} 
n_year_estimates(prevalence_total, num_years_to_estimate = 3, population_size = 3.5e6)

n_year_estimates(prevalence_total, num_years_to_estimate = 5, population_size = 3.5e6)

n_year_estimates(prevalence_total, num_years_to_estimate = 10, population_size = 3.5e6)
```

### Age distribution of prevalent cases

The age distribution of simulated prevalent cases can be viewed as a histogram and compared with the age distribution of counted prevalent cases:

```{r, fig.height = 4, fig.width = 7}
prevsim_r$status2 <- ifelse(prevsim_r$eventdate > "2013-01-30", 
                                  0, prevsim_r$status)
observed_post_age_dist_total <- 
  prevsim_r$age[prevsim_r$status2 == 0]

post_age_dist_total <- prevalence_total$post_covar

hist(observed_post_age_dist_total, 
     col=rgb(0.1, 0.1, 0.1, 0.5), xlim=c(0,100), ylim=c(0,0.045), 
     main = "", xlab = "age", prob = TRUE)
hist(post_age_dist_total, 
     col=rgb(0.8, 0.8, 0.8, 0.5), prob = TRUE, add=T)
legend("topleft", legend = c("Observed", "Predicted"), bty = "n", lty = 1, 
       col = c(rgb(0.1, 0.1, 0.1, 0.5),
               rgb(0.8, 0.8, 0.8, 0.5)))
```
