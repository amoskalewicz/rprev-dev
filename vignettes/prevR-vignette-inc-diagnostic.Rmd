---
title: "prevR Incidence Vignette"
author: "Stephanie J. Lax"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{prevR Vignette Comp}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This document tests the ability of the prevR package to calculate incidence from a synthetic patient dataset. 

```{r backgroundsetup, echo = FALSE, message = FALSE}
library(devtools)
devtools::load_all()
```

## Basic Experimental Setup

```{r setup, message = FALSE, warning = FALSE, error = TRUE}
library(abind)
library(dplyr)
library(rms)
library(survival)

load("../data/registry_data.rda")
summary(registry_data)

# Total:
summary(load_data(registry_data))

# Males:
summary(load_data(registry_data, sex = "Males"))

# Females:
summary(load_data(registry_data, sex = "Fmales"))

summary(load_data(registry_data, sex = "Females"))

# Total adult cases:
summary(load_data(registry_data, age_division = "Adult"))

# Adult males:
summary(load_data(registry_data, sex = "Males", age_division = "Adult"))

# Adult females:
summary(load_data(registry_data, sex = "Females", age_division = "Adult"))

# Total pediatric cases:
summary(load_data(registry_data, age_division = "Pediatric"))

# Total paediatric cases:
summary(load_data(registry_data, age_division = "Paediatric"))

# Paediatric males:
summary(load_data(registry_data, age_division = "Paediatric", sex = "Males"))

# Paediatric fmmales:
summary(load_data(registry_data, age_division = "Paediatric", sex = "Fmmales"))

# Paediatric females:
summary(load_data(registry_data, age_division = "Paediatric", sex = "Females"))
```

## Elementary Calculations

### Raw Incidence

```{r incidence, error = TRUE}
registry_years <- c("2004-09-01", "2005-09-01", "2006-09-01", "2007-09-01", "2008-09-01",
                    "2009-09-01", "2010-09-01", "2011-09-01", "2012-09-01", "2013-09-01")
registry_start_year <- 2
registry_end_year <- 9

raw_incidence <- incidence(load_data(registry_data), 
                           registry_years, registry_start_year, registry_end_year)
raw_incidence

raw_incidence2 <- incidence(load_data(registry_data, sex = "Males"), 
                           registry_years, registry_start_year, registry_end_year)
raw_incidence2

raw_incidence4 <- incidence(load_data(registry_data, sex = "Females"), 
                           registry_years, registry_start_year, registry_end_year)
raw_incidence4

raw_incidence2 + raw_incidence4

raw_incidence5 <- incidence(load_data(registry_data, age_division = "Adult", age_cut = 20), 
                           registry_years, registry_start_year, registry_end_year)

raw_incidence5

raw_incidence7 <- incidence(load_data(registry_data, age_division = "Paediatric", age_cut = 20), 
                           registry_years, registry_start_year, registry_end_year)
raw_incidence7

raw_incidence5 + raw_incidence7

raw_incidence8 <- incidence(load_data(registry_data, age_division = "Paediatric", age_cut = 20,
                                      sex = "Males"), 
                           registry_years, registry_start_year, registry_end_year)
raw_incidence8

raw_incidence9 <- incidence(load_data(registry_data, age_division = "Paediatric", age_cut = 20,
                                      sex = "Females"), 
                           registry_years, registry_start_year, registry_end_year)
raw_incidence9

raw_incidence8 + raw_incidence9
```

#### Incidence Diagnostics

##### All Ages

```{r incidencediag, fig.width = 7, fig.height = 4, error = TRUE}
par(mfrow=c(1,2))
plot(raw_incidence2, pch=20, cex=2, col="blue", main = "All Cases", 
     xlab="year", ylab="diagnoses", ylim=c(0, 200))
lines(raw_incidence2, lwd=2)
points(raw_incidence4, pch=20, cex=2, col="red")
lines(raw_incidence4, lwd=2)

plot(raw_incidence2/raw_incidence, pch=20, cex=2, col="blue", xlab="year", 
     ylab="sex ratio (m/f)")
lines(raw_incidence2/raw_incidence)
abline(h=0.5, col="red", lwd=2)

sum(raw_incidence2)/sum(raw_incidence)
sum(raw_incidence4)/sum(raw_incidence)
```

#### Paediatric Cases

```{r incidencediag2, fig.width = 7, fig.height = 4, error = TRUE}
par(mfrow=c(1,2))
plot(raw_incidence8, pch=20, cex=2, col="blue", main = "Paediatric Cases", 
     xlab="year", ylab="diagnoses", ylim=c(0, 12))
lines(raw_incidence8, lwd=2)
points(raw_incidence9, pch=20, cex=2, col="red")
lines(raw_incidence9, lwd=2)

plot(raw_incidence8/raw_incidence7, pch=20, cex=2, col="blue", xlab="year", 
     ylab="sex ratio (m/f)")
lines(raw_incidence8/raw_incidence7)
abline(h=0.5, col="red", lwd=2)

sum(raw_incidence8)/sum(raw_incidence7)
sum(raw_incidence9)/sum(raw_incidence7)
```

```{r incidencediag3, fig.width = 7, fig.height = 4, echo = FALSE, error = TRUE}
par(mfrow=c(1,1))
```

### Incidence Rate

```{r incidencerate, error = TRUE}
incidence_rates <- meanIR(load_data(registry_data), registry_years, registry_start_year, 
                          registry_end_year, population_size = 3500000)
incidence_rates

incidence_rates2 <- meanIR(load_data(registry_data, sex = "Males"), registry_years, registry_start_year, 
                          registry_end_year, population_size = 1700000)
incidence_rates2

incidence_rates4 <- meanIR(load_data(registry_data, sex = "Females"), registry_years, registry_start_year, 
                          registry_end_year, population_size = 1800000)
incidence_rates4

incidence_rates2[[1]][1] + incidence_rates4[[1]][1]

incidence_rates5 <- meanIR(load_data(registry_data, age_division = "Adult", age_cut = 20), 
                           registry_years, registry_start_year, registry_end_year, 
                           population_size = 2550000)
incidence_rates5

incidence_rates7 <- meanIR(load_data(registry_data, age_division = "Paediatric", age_cut = 20), 
                           registry_years, registry_start_year, registry_end_year, 
                           population_size = 950000)
incidence_rates7

incidence_rates5[[1]][1] + incidence_rates7[[1]][1]

incidence_rates8 <- meanIR(load_data(registry_data, age_division = "Paediatric", 
                                     age_cut = 20, sex = "Males"), 
                           registry_years, registry_start_year, registry_end_year, 
                           population_size = 500000)
incidence_rates8

incidence_rates9 <- meanIR(load_data(registry_data, age_division = "Paediatric", 
                                     age_cut = 20, sex = "Females"), 
                           registry_years, registry_start_year, registry_end_year, 
                           population_size = 450000)
incidence_rates9

incidence_rates8[[1]][1] + incidence_rates9[[1]][1]
```

#### Incidence Rate Diagnostics

Total cases:

```{r ratediag1, error = TRUE}
sim_check(raw_incidence)
```

Male cases:

```{r ratediag2, error = TRUE}
sim_check(raw_incidence2)
```

Female cases:

```{r ratediag3, error = TRUE}
sim_check(raw_incidence4)
```

Adult cases:

```{r ratediag4, error = TRUE}
sim_check(raw_incidence5)
```

Paediatic cases:

```{r ratediag5, error = TRUE}
sim_check(raw_incidence7)
```

Male Paediatric cases:

```{r ratediag6, error = TRUE}
sim_check(raw_incidence8)
```

Female Paediatric cases:

```{r ratediag7, error = TRUE}
sim_check(raw_incidence9)
```

#### Consistency with Homogeneous Poisson Process

Comparison:

```{r pp, fig.width = 7, fig.height = 3, error = TRUE}
N <- 1000
x <- runif(N)
x <- sort(x)

par(mfrow=c(1,3))
plot(x, 1:N, pch=20, cex=0.7, xlab="days", ylab="cumulative diagnoses")
abline(a=0, b=N, col="red", lwd=2)
smo <- smooth.spline(x, 1:N, df=4)
lines(smo, col="green", lwd=2)
  
plot(x, (1:N) - predict(smo, x)$y, type="l", main="incidence rate")
  
pre_smo <- predict(smo, x, deriv=1)
plot(pre_smo, type="l", lwd=2, col="green", 
     xlab="days after start of HMRN", ylab="incidence rate")
```

Total Cases:

```{r pp2, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data), registry_years, registry_start_year, 
         registry_end_year, N=1000, df=6)
```

```{r pp22, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data), registry_years, 
                           registry_start_year, registry_end_year)
```

Males:

```{r pp3, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data, sex = "Males"), registry_years, registry_start_year, 
         registry_end_year, N=1000, df=6)
```

```{r pp33, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data, sex = "Males"), registry_years, 
                           registry_start_year, registry_end_year)
```

Females:

```{r pp4, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data, sex = "Females"), registry_years, registry_start_year, 
         registry_end_year, N=1000, df=6)
```

```{r pp44, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data, sex = "Females"), registry_years, 
                           registry_start_year, registry_end_year)
```

Adults:

```{r pp5, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data, age_division = "Adult", age_cut = 20), 
                   registry_years, registry_start_year, registry_end_year, N=1000, df=6)
```

```{r pp55, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data, age_division = "Adult", age_cut = 20), 
                           registry_years, registry_start_year, registry_end_year)
```

Adult Males:

```{r pp17, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data, age_division = "Adult", age_cut = 20,
                             sex = "Males"), 
                   registry_years, registry_start_year, registry_end_year, N=1000, df=6)
```

```{r pp177, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data, age_division = "Adult", 
                                     age_cut = 20, sex = "Males"), 
                           registry_years, registry_start_year, registry_end_year)
```

Adult Females:

```{r pp18, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data, age_division = "Adult", age_cut = 20,
                             sex = "Females"), 
                   registry_years, registry_start_year, registry_end_year, N=1000, df=6)
```

```{r pp188, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data, age_division = "Adult", 
                                     age_cut = 20, sex = "Females"), 
                           registry_years, registry_start_year, registry_end_year)
```

Paediatrics:

```{r pp6, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data, age_division = "Paediatric", age_cut = 20), 
                   registry_years, registry_start_year, registry_end_year, N=1000, df=6)
```

```{r pp66, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data, age_division = "Paediatric", age_cut = 20), 
                           registry_years, registry_start_year, registry_end_year)
```

Paediatric Males:

```{r pp7, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data, age_division = "Paediatric", age_cut = 20,
                             sex = "Males"), 
                   registry_years, registry_start_year, registry_end_year, N=1000, df=6)
```

```{r pp77, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data, age_division = "Paediatric", 
                                     age_cut = 20, sex = "Males"), 
                           registry_years, registry_start_year, registry_end_year)
```

Paediatric Females:

```{r pp8, fig.width = 7, fig.height = 7, include = TRUE, results="hide", error = TRUE}
par(mfrow=c(2,2))
smoothed_incidence(load_data(registry_data, age_division = "Paediatric", age_cut = 20,
                             sex = "Females"), 
                   registry_years, registry_start_year, registry_end_year, N=1000, df=6)
```

```{r pp88, fig.width = 4, fig.height = 4, error = TRUE}
par(mfrow=c(1,1))
incidence_age_distribution(load_data(registry_data, age_division = "Paediatric", 
                                     age_cut = 20, sex = "Females"), 
                           registry_years, registry_start_year, registry_end_year)
```
