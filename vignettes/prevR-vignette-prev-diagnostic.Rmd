---
title: "prevR Prevalence Vignette"
author: "Stephanie J. Lax"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{prevR Vignette Comp}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This document tests the ability of the prevR package to predict prevalence from a synthetic patient dataset. 

```{r backgroundsetup, echo = FALSE, message = FALSE, warning = FALSE}
library(devtools)
devtools::load_all()

library(abind)
library(dplyr)
library(rms)
library(survival)

load("../data/registry_data.rda")

registry_years <- c("2004-09-01", "2005-09-01", "2006-09-01", "2007-09-01", "2008-09-01",
                    "2009-09-01", "2010-09-01", "2011-09-01", "2012-09-01", "2013-09-01")
registry_start_year <- 2
registry_end_year <- 9
cure <- 3

load("../data/population_data_mx.rda")

daily_survival_rate_males <- daily_survival_rate(population_data_mx, sex = "Males")
daily_survival_males <- cumprod(1 - daily_survival_rate_males)

daily_survival_rate_females <- daily_survival_rate(population_data_mx, sex = "Females")
daily_survival_females <- cumprod(1 - daily_survival_rate_females)

registry_data_r <- load_data(registry_data)
registry_data_r <- registry_data_r[registry_data_r$date_initial >= 
                                     registry_years[registry_start_year], ]

wb <- survreg(Surv(survival_time, indicator) ~ age_initial + sex, data=registry_data_r)
summary(wb)
```

## Prevalence Calculations

### Counted Prevalence

```{r survival, error = TRUE}
counted_prevalence <- counted_prevalence(load_data(registry_data), registry_years, 
                                   registry_start_year, registry_end_year)
counted_prevalence

counted_prevalence2 <- counted_prevalence(load_data(registry_data, sex = "Males"), registry_years, 
                                   registry_start_year, registry_end_year)
counted_prevalence2

counted_prevalence4 <- counted_prevalence(load_data(registry_data, sex = "Females"), registry_years, 
                                   registry_start_year, registry_end_year)
counted_prevalence4

counted_prevalence2 + counted_prevalence4

counted_prevalence5 <- counted_prevalence(load_data(registry_data, age_division = "Adult", age_cut = 20), 
                                    registry_years, registry_start_year, registry_end_year)
counted_prevalence5

counted_prevalence7 <- counted_prevalence(load_data(registry_data, age_division = "Paediatric", age_cut = 20), 
                                    registry_years, registry_start_year, registry_end_year)
counted_prevalence7

counted_prevalence5 + counted_prevalence7

counted_prevalence8 <- counted_prevalence(load_data(registry_data, age_division = "Paediatric", age_cut = 20,
                                              sex = "Males"), 
                                    registry_years, registry_start_year, registry_end_year)
counted_prevalence8

counted_prevalence9 <- counted_prevalence(load_data(registry_data, age_division = "Paediatric", age_cut = 20,
                                              sex = "Females"), 
                                    registry_years, registry_start_year, registry_end_year)
counted_prevalence9

counted_prevalence8 + counted_prevalence9
```

### Predicted Prevalence

#### Total

```{r prevalencetotal, fig.width = 6, fig.height = 4, error = TRUE}
N_years <- 20

prevalence_total <- prevalence(load_data(registry_data), registry_years, registry_start_year, 
                               registry_end_year, N_years, 
                               daily_survival_males = daily_survival_males, 
                               daily_survival_females = daily_survival_females, 
                               cure_time = cure*365)

by_year_total <- prevalence_total[[1]]
by_year_total

prev_chisq(load_data(registry_data), registry_years, registry_start_year, registry_end_year, 
           by_year = by_year_total)

post_age_dist_total <- prevalence_total[[2]]
hist(post_age_dist_total, prob = TRUE)

observed <- counted_prevalence(load_data(registry_data), registry_years, registry_start_year, 
                               registry_end_year)
by_year_total[1:(registry_end_year - registry_start_year + 1)] <- rev(observed)
observed_post_age_dist_total <- 
  registry_data_r$age_initial[registry_data_r$indicator_censored_at_index == 0]
hist(observed_post_age_dist_total, prob = TRUE)

sum(by_year_total)

age_props <- prevalence_by_age(dist = post_age_dist_total, registry_end_year, N_years)
age_props
sum(age_props)

total_predictedyrs <- sum(by_year_total[registry_end_year:N_years]) * age_props
sum(total_predictedyrs)
sum(by_year_total[registry_end_year:N_years])

by_year_samples_total <- prevalence_total[[3]]
by_sample_total <- apply(by_year_samples_total, 2, sum)
summary(by_sample_total)

total3yr <- n_year_estimates(N_years = 3, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_total, by_year = by_year_total,
                             population_size = 3500000)
total3yr

total5yr <- n_year_estimates(N_years = 5, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_total, by_year = by_year_total,
                             population_size = 3500000)
total5yr

total10yr <- n_year_estimates(N_years = 10, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_total, by_year = by_year_total,
                             population_size = 3500000)
total10yr

total20yr <- n_year_estimates(N_years = 20, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_total, by_year = by_year_total,
                             population_size = 3500000)
total20yr
```

#### Males

```{r prevalenceinmales, fig.width = 6, fig.height = 4, error = TRUE}
prevalence_males <- prevalence(load_data(registry_data, sex = "Males"), registry_years, registry_start_year, 
                               registry_end_year, N_years, 
                               daily_survival_males = daily_survival_males, 
                               cure_time = cure*365)

by_year_males <- prevalence_males[[1]]
by_year_males

prev_chisq(load_data(registry_data, sex = "Males"), registry_years, registry_start_year, registry_end_year, 
           by_year = by_year_males)

post_age_dist_males <- prevalence_males[[2]]
hist(post_age_dist_males, prob = TRUE)

observed <- counted_prevalence(load_data(registry_data, sex = "Males"), registry_years, registry_start_year, 
                               registry_end_year)
by_year_males[1:(registry_end_year - registry_start_year + 1)] <- rev(observed)
observed_post_age_dist_males <- 
  registry_data_r$age_initial[registry_data_r$indicator_censored_at_index == 0 & 
                                registry_data_r$sex == 0]
hist(observed_post_age_dist_males, prob = TRUE)

sum(by_year_males)

age_props <- prevalence_by_age(dist = post_age_dist_males, registry_end_year, N_years)
age_props
sum(age_props)

males_predictedyrs <- sum(by_year_males[registry_end_year:N_years]) * age_props
sum(males_predictedyrs)
sum(by_year_males[registry_end_year:N_years])

by_year_samples_males <- prevalence_males[[3]]
by_sample_males <- apply(by_year_samples_males, 2, sum)
summary(by_sample_males)

males3yr <- n_year_estimates(N_years = 3, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_males, by_year = by_year_males,
                             population_size = 1700000)
males3yr

males5yr <- n_year_estimates(N_years = 5, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_males, by_year = by_year_males,
                             population_size = 1700000)
males5yr

males10yr <- n_year_estimates(N_years = 10, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_males, by_year = by_year_males,
                             population_size = 1700000)
males10yr

males20yr <- n_year_estimates(N_years = 20, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_males, by_year = by_year_males,
                             population_size = 1700000)
males20yr
```

#### Females

```{r prevalencefemales, fig.width = 6, fig.height = 4, error = TRUE}
prevalence_females <- prevalence(load_data(registry_data, sex = "Females"), registry_years, registry_start_year, 
                               registry_end_year, N_years, 
                               daily_survival_females = daily_survival_females, 
                               cure_time = cure*365)

by_year_females <- prevalence_females[[1]]
by_year_females

prev_chisq(load_data(registry_data, sex = "Females"), registry_years, registry_start_year, registry_end_year, 
           by_year = by_year_females)

post_age_dist_females <- prevalence_females[[2]]
hist(post_age_dist_females, prob = TRUE)

observed <- counted_prevalence(load_data(registry_data, sex = "Females"), registry_years, registry_start_year, 
                               registry_end_year)
by_year_females[1:(registry_end_year - registry_start_year + 1)] <- rev(observed)
observed_post_age_dist_females <- 
  registry_data_r$age_initial[registry_data_r$indicator_censored_at_index == 0 & 
                                registry_data_r$sex == 1]
hist(observed_post_age_dist_females, prob = TRUE)

sum(by_year_females)

age_props <- prevalence_by_age(dist = post_age_dist_females, registry_end_year, N_years)
age_props
sum(age_props)

females_predictedyrs <- sum(by_year_females[registry_end_year:N_years]) * age_props
sum(females_predictedyrs)
sum(by_year_females[registry_end_year:N_years])

by_year_samples_females <- prevalence_females[[3]]
by_sample_females <- apply(by_year_samples_females, 2, sum)
summary(by_sample_females)

females3yr <- n_year_estimates(N_years = 3, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_females, by_year = by_year_females,
                             population_size = 1800000)
females3yr

females5yr <- n_year_estimates(N_years = 5, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_females, by_year = by_year_females,
                             population_size = 1800000)
females5yr

females10yr <- n_year_estimates(N_years = 10, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_females, by_year = by_year_females,
                             population_size = 1800000)
females10yr

females20yr <- n_year_estimates(N_years = 20, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_females, by_year = by_year_females,
                             population_size = 1800000)
females20yr
```

#### Adults

```{r prevalenceadult, fig.width = 6, fig.height = 4, error=TRUE}
prevalence_adults <- prevalence(load_data(registry_data, age_division = "Adult", age_cut = 20), 
                                registry_years, registry_start_year, registry_end_year, N_years, 
                                daily_survival_males = daily_survival_males, 
                                daily_survival_females = daily_survival_females, cure_time = cure*365)

by_year_adults <- prevalence_adults[[1]]
by_year_adults

prev_chisq(load_data(registry_data, age_division = "Adult", age_cut = 20), registry_years, 
           registry_start_year, registry_end_year, by_year = by_year_adults)

post_age_dist_adults <- prevalence_adults[[2]]
hist(post_age_dist_adults, prob = TRUE)

observed <- counted_prevalence(load_data(registry_data, age_division = "Adult", age_cut = 20), 
                               registry_years, registry_start_year, registry_end_year)
by_year_adults[1:(registry_end_year - registry_start_year + 1)] <- rev(observed)
observed_post_age_dist_adults <- 
  registry_data_r$age_initial[registry_data_r$indicator_censored_at_index == 0 & 
                              registry_data_r$age_initial >= 20]
hist(observed_post_age_dist_adults, prob = TRUE)

sum(by_year_adults)

age_props <- prevalence_by_age(dist = post_age_dist_adults, registry_end_year, N_years)
age_props
sum(age_props)

by_year_samples_adults <- prevalence_adults[[3]]
by_sample_adults <- apply(by_year_samples_adults, 2, sum)
summary(by_sample_adults)

adults3yr <- n_year_estimates(N_years = 3, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adults, by_year = by_year_adults,
                             population_size = 2550000)
adults3yr

adults5yr <- n_year_estimates(N_years = 5, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adults, by_year = by_year_adults,
                             population_size = 2550000)
adults5yr

adults10yr <- n_year_estimates(N_years = 10, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adults, by_year = by_year_adults,
                             population_size = 2550000)
adults10yr

adults20yr <- n_year_estimates(N_years = 20, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adults, by_year = by_year_adults,
                             population_size = 2550000)
adults20yr
```

#### Adult Male Cases

```{r adultprevm, fig.width = 6, fig.height = 4, error=TRUE}
prevalence_adultsm <- prevalence(load_data(registry_data, sex = "Males", age_division = "Adult", age_cut = 20), 
                                registry_years, registry_start_year, registry_end_year, N_years, 
                                daily_survival_males = daily_survival_males, cure_time = cure*365)

by_year_adultsm <- prevalence_adultsm[[1]]
by_year_adultsm

prev_chisq(load_data(registry_data, sex = "Males", age_division = "Adult", age_cut = 20), registry_years, 
           registry_start_year, registry_end_year, by_year = by_year_adultsm)

post_age_dist_adultsm <- prevalence_adultsm[[2]]
hist(post_age_dist_adultsm, prob = TRUE)

observed <- counted_prevalence(load_data(registry_data, sex = "Males", age_division = "Adult", age_cut = 20), 
                               registry_years, registry_start_year, registry_end_year)
by_year_adultsm[1:(registry_end_year - registry_start_year + 1)] <- rev(observed)
observed_post_age_dist_adultsm <- 
  registry_data_r$age_initial[registry_data_r$indicator_censored_at_index == 0 & 
                              registry_data_r$age_initial >= 20 & 
                              registry_data_r$sex == 0]
hist(observed_post_age_dist_adultsm, prob = TRUE)

sum(by_year_adultsm)

age_props <- prevalence_by_age(dist = post_age_dist_adultsm, registry_end_year, N_years)
age_props
sum(age_props)

by_year_samples_adultsm <- prevalence_adultsm[[3]]
by_sample_adultsm <- apply(by_year_samples_adultsm, 2, sum)
summary(by_sample_adultsm)

adultsm3yr <- n_year_estimates(N_years = 3, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adultsm, by_year = by_year_adultsm,
                             population_size = 1350000)
adultsm3yr

adultsm5yr <- n_year_estimates(N_years = 5, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adultsm, by_year = by_year_adultsm,
                             population_size = 1350000)
adultsm5yr

adultsm10yr <- n_year_estimates(N_years = 10, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adultsm, by_year = by_year_adultsm,
                             population_size = 1350000)
adultsm10yr

adultsm20yr <- n_year_estimates(N_years = 20, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adultsm, by_year = by_year_adultsm,
                             population_size = 1350000)
adultsm20yr
```

#### Adult Female Cases

```{r adultprevf, fig.width = 6, fig.height = 4, error=TRUE}
prevalence_adultsf <- prevalence(load_data(registry_data, sex = "Females", age_division = "Adult", age_cut = 20), 
                                registry_years, registry_start_year, registry_end_year, N_years, 
                                daily_survival_females = daily_survival_females, cure_time = cure*365)

by_year_adultsf <- prevalence_adultsf[[1]]
by_year_adultsf

prev_chisq(load_data(registry_data, sex = "Females", age_division = "Adult", age_cut = 20), registry_years, 
           registry_start_year, registry_end_year, by_year = by_year_adultsf)

post_age_dist_adultsf <- prevalence_adultsf[[2]]
hist(post_age_dist_adultsf, prob = TRUE)

observed <- counted_prevalence(load_data(registry_data, sex = "Females", age_division = "Adult", age_cut = 20), 
                               registry_years, registry_start_year, registry_end_year)
by_year_adultsf[1:(registry_end_year - registry_start_year + 1)] <- rev(observed)
observed_post_age_dist_adultsf <- 
  registry_data_r$age_initial[registry_data_r$indicator_censored_at_index == 0 & 
                              registry_data_r$age_initial >= 20 & 
                              registry_data_r$sex == 1]
hist(observed_post_age_dist_adultsf, prob = TRUE)

sum(by_year_adultsf)

age_props <- prevalence_by_age(dist = post_age_dist_adultsf, registry_end_year, N_years)
age_props
sum(age_props)

by_year_samples_adultsf <- prevalence_adultsf[[3]]
by_sample_adultsf <- apply(by_year_samples_adultsf, 2, sum)
summary(by_sample_adultsf)

adultsf3yr <- n_year_estimates(N_years = 3, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adultsf, by_year = by_year_adultsf,
                             population_size = 1200000)
adultsf3yr

adultsf5yr <- n_year_estimates(N_years = 5, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adultsf, by_year = by_year_adultsf,
                             population_size = 1200000)
adultsf5yr

adultsf10yr <- n_year_estimates(N_years = 10, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adultsf, by_year = by_year_adultsf,
                             population_size = 1200000)
adultsf10yr

adultsf20yr <- n_year_estimates(N_years = 20, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_adultsf, by_year = by_year_adultsf,
                             population_size = 1200000)
adultsf20yr
```

#### Paediatric Cases

```{r paediatricprev, fig.width = 6, fig.height = 4, error=TRUE}
prevalence_paeds <- prevalence(load_data(registry_data, age_division = "Paediatric", age_cut = 20), 
                                registry_years, registry_start_year, registry_end_year, N_years, 
                                daily_survival_males = daily_survival_males, 
                                daily_survival_females = daily_survival_females, cure_time = cure*365)

by_year_paeds <- prevalence_paeds[[1]]
by_year_paeds

prev_chisq(load_data(registry_data, age_division = "Paediatric", age_cut = 20), registry_years, 
           registry_start_year, registry_end_year, by_year = by_year_paeds)

post_age_dist_paeds <- prevalence_paeds[[2]]
hist(post_age_dist_paeds, prob = TRUE)

observed <- counted_prevalence(load_data(registry_data, age_division = "Paediatric", age_cut = 20), 
                               registry_years, registry_start_year, registry_end_year)
by_year_paeds[1:(registry_end_year - registry_start_year + 1)] <- rev(observed)
observed_post_age_dist_paeds <- 
  registry_data_r$age_initial[registry_data_r$indicator_censored_at_index == 0 & 
                              registry_data_r$age_initial < 20]
hist(observed_post_age_dist_paeds, prob = TRUE)

sum(by_year_paeds)

age_props <- prevalence_by_age(dist = post_age_dist_paeds, registry_end_year, N_years)
age_props
sum(age_props)

by_year_samples_paeds <- prevalence_paeds[[3]]
by_sample_paeds <- apply(by_year_samples_paeds, 2, sum)
summary(by_sample_paeds)

paeds3yr <- n_year_estimates(N_years = 3, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_paeds, by_year = by_year_paeds,
                             population_size = 950000)
paeds3yr

paeds5yr <- n_year_estimates(N_years = 5, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_paeds, by_year = by_year_paeds,
                             population_size = 950000)
paeds5yr

paeds10yr <- n_year_estimates(N_years = 10, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_paeds, by_year = by_year_paeds,
                             population_size = 950000)
paeds10yr

paeds20yr <- n_year_estimates(N_years = 20, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_paeds, by_year = by_year_paeds,
                             population_size = 950000)
paeds20yr
```

#### Male Paediatric Cases

```{r paediatricprevm, fig.width = 6, fig.height = 4, error=TRUE, warning=FALSE}
prevalence_paedsm <- prevalence(load_data(registry_data, sex = "Males", age_division = "Paediatric", age_cut = 20), 
                                registry_years, registry_start_year, registry_end_year, N_years, 
                                daily_survival_males = daily_survival_males, cure_time = cure*365)
```

*This indicates that the simulation may have failed due to lack of events. However, the rest of the calculations do proceed:*

#### Female Paediatric Cases

```{r paediatricprevf, fig.width = 6, fig.height = 4, error=TRUE}
prevalence_paedsf <- prevalence(load_data(registry_data, sex = "Females", age_division = "Paediatric", age_cut = 20), 
                                registry_years, registry_start_year, registry_end_year, N_years, 
                                daily_survival_females = daily_survival_females, cure_time = cure*365)





by_year_paedsf <- prevalence_paedsf[[1]]
by_year_paedsf

prev_chisq(load_data(registry_data, sex = "Females", age_division = "Paediatric", age_cut = 20), registry_years, 
           registry_start_year, registry_end_year, by_year = by_year_paedsf)

post_age_dist_paedsf <- prevalence_paedsf[[2]]
hist(post_age_dist_paedsf, prob = TRUE)

observed <- counted_prevalence(load_data(registry_data, sex = "Females", age_division = "Paediatric", age_cut = 20), 
                               registry_years, registry_start_year, registry_end_year)
by_year_paedsf[1:(registry_end_year - registry_start_year + 1)] <- rev(observed)
observed_post_age_dist_paedsf <- 
  registry_data_r$age_initial[registry_data_r$indicator_censored_at_index == 0 & 
                              registry_data_r$age_initial < 20 & 
                              registry_data_r$sex == 1]
hist(observed_post_age_dist_paedsf, prob = TRUE)

sum(by_year_paedsf)

age_props <- prevalence_by_age(dist = post_age_dist_paedsf, registry_end_year, N_years)
age_props
sum(age_props)

by_year_samples_paedsf <- prevalence_paedsf[[3]]
by_sample_paedsf <- apply(by_year_samples_paedsf, 2, sum)
summary(by_sample_paedsf)

paedsf3yr <- n_year_estimates(N_years = 3, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_paedsf, by_year = by_year_paedsf,
                             population_size = 450000)
paedsf3yr

paedsf5yr <- n_year_estimates(N_years = 5, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_paedsf, by_year = by_year_paedsf,
                             population_size = 450000)
paedsf5yr

paedsf10yr <- n_year_estimates(N_years = 10, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_paedsf, by_year = by_year_paedsf,
                             population_size = 450000)
paedsf10yr

paedsf20yr <- n_year_estimates(N_years = 20, registry_start_year = registry_start_year, 
                             registry_end_year = registry_end_year, 
                             the_samples = by_year_samples_paedsf, by_year = by_year_paedsf,
                             population_size = 450000)
paedsf20yr
```
