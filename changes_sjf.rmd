---
title: "changes_sjl"
author: "S J Lax"
date: "5 May 2016"
output: html_document
---

# Steph does unit testing! {.tabset}

## Setup

```{r setup, echo=FALSE, message = FALSE, warning=FALSE}
library(devtools)
devtools::load_all()

library(dplyr)
library(abind)
library(rms)
library(survival)
library(knitr)
library(tidyr)
library(ggplot2)
library(dplyr)
library(testthat)
```

```{r data, cache=TRUE}
load("H:/Repos/prevR/data/prevsim.rda")
registry_data <- prevsim

summary(registry_data)
```

Using Stuart's custom function:

```{r test}
test_output <- function(old_func, new_func) {
    expected <- old_func()
    actual <- new_func()
    test <- tryCatch(all(expected == actual),
                     error=function(cond) FALSE)
    if (test) {
        message("Success!")
    } else {
        message("Failure...")
        message("Expected:")
        print(expected)
        message("Actual:") 
        print(actual)
    }
}
```

## counted_prevalence

```{r counted_prevalence}
countprev_dev <- function() {
  counted_prevalence(registry_data$entrydate, 
                     registry_data$eventdate, 
                     registry_data$status, 
                     start="2004-01-30", 9)
}
```

```{r counted_prevalence_current, cache=TRUE}
registry_years <- c("2003-01-30", "2004-01-30", "2005-01-30", "2006-01-30", "2007-01-30", "2008-01-30",
                      "2009-01-30", "2010-01-30", "2011-01-30", "2012-01-30", "2013-01-30")
registry_start_year <- 2
registry_end_year <- 10

registry_data$status2 <- ifelse(registry_data$eventdate > "2013-01-30", 0, registry_data$status)
registry_data$indicator_censored_at_index <- registry_data$status2
registry_data$date_initial <- registry_data$entrydate
registry_data$date_event <- registry_data$eventdate
registry_data$indicator <- registry_data$status
registry_data$survival_time <- registry_data$time
registry_data$age_initial <- registry_data$age
  
countprev_current_output <- function() {
  
  counted_prevalence_current(registry_data, registry_years, 
                             registry_start_year, registry_end_year)
}
```

```{r counted_prevalence_comp, message=T, cache=TRUE}
test_output(countprev_current_output, countprev_dev)
```

## prev_chisq

```{r check_prevalence, cache=TRUE}
prevalence_total <- prevalence(Surv(time, status) ~ sex(sex) + age(age) + entry(entrydate),
                               registry_data, N_years = 10, cure_time = 10*365, 
                               start='2004-01-30', num_years=9)

by_year_total <- prevalence_total[[1]]

prevchisq_dev <- function() {
  prev_chisq(registry_data$entrydate,
            registry_data$eventdate, 
            registry_data$status, 
            start="2004-01-30", 9,
            by_year = by_year_total)
}
```

```{r check_prevalence_current}
prevchisq_current_output <- function() {
  prev_chisq_current(registry_data, registry_years, registry_start_year, registry_end_year, by_year = by_year_total)
}
```

```{r check_prevalence_comp, message=T, cache=TRUE}
test_output(prevchisq_current_output, prevchisq_dev)
```

## incidence_age_distribution

```{r check_incidence_age_distribution}
registry_data_r <- registry_data[registry_data$entrydate >= "2004-01-30",]

incidence_age_distribution_dev <- function() {
  incidence_age_distribution(registry_data_r$age)
}
```

```{r check_incidence_age_distribution_current}
incidence_age_distribution_current_output <- function() {
  incidence_age_distribution_current(registry_data, registry_years, registry_start_year, registry_end_year)
}
```

```{r check_incidence_age_distribution_comp, message=T, cache=TRUE}
test_output(incidence_age_distribution_current_output, incidence_age_distribution_dev)
```

## functional_form_age

```{r check_functional_form_age}
functional_form_age_dev <- function() {
  registry_data_r <- registry_data[registry_data$date_initial >= 
                                         registry_years[registry_start_year] & 
                                         registry_data$date_initial < registry_years[registry_end_year], ]
  functional_form_age(Surv(time, status) ~ age(age), registry_data_r)
}
```

```{r check_functional_form_age_current}
functional_form_age_current_output <- function() {
  functional_form_age_current(registry_data, registry_years, registry_start_year, registry_end_year)
}
```

```{r check_functional_form_age_comp, message=T, include=TRUE, fig.show=FALSE, cache=TRUE}
test_output(functional_form_age_current_output, functional_form_age_dev)
```

Although there is a failure here, the output from coxph looks exactly the same. A more detailed manual check shows this to be the case:

```{r manual, message=T, include=TRUE, fig.show=FALSE, cache=TRUE}
dev <- functional_form_age_dev()
cur <- functional_form_age_current_output()

dev[[1]] == cur[[1]]
dev[[4]] == cur[[4]]
dev[[5]] == cur[[5]]
```

The list elements were compared by inspection and were the same. I also tried comparisons with `testthat`:

```{r testthat, message=T, error=TRUE, include=TRUE, fig.show=FALSE, cache=TRUE}
test_that("functional form dev matches functional form cur",{
    expect_equal(dev, cur)
})
```

```{r testthat_detailed, message=T, error=TRUE, include=TRUE, fig.show=FALSE, cache=TRUE}

test_that("functional form dev matches functional form cur [[2]]",{
    expect_equal(dev[[2]], cur[[2]])
})

test_that("functional form dev matches functional form cur [[3]]",{
    expect_equal(dev[[3]], cur[[3]])
})

test_that("functional form dev matches functional form cur [[4]]",{
    expect_equal(dev[[4]], cur[[4]])
})

test_that("functional form dev matches functional form cur [[5]]",{
    expect_equal(dev[[5]], cur[[5]])
})
```

I need to get to the bottom of why these errors occur, and at some point I need to control the plotting side effects.

## survival_modelling_diagnostics

```{r check_survival_modelling_diagnostics_age}
survival_modelling_diagnostics_dev <- function() {
  par(mfrow=c(2,2))
  survival_modelling_diagnostics_sim(Surv(time, status) ~ age(age) + entry(entrydate),
                                 registry_data, ages = c(55, 65, 75, 85, 100), 
                                 start = "2004-09-01", num_years = 9)
}
```

```{r check_survival_modelling_diagnostics_current}
survival_modelling_diagnostics_current_output <- function() {
  registry_years <- c("2003-01-30", "2004-01-30", "2005-01-30", "2006-01-30", "2007-01-30", "2008-01-30",
                      "2009-01-30", "2010-01-30", "2011-01-30", "2012-01-30", "2013-01-30")
  registry_start_year <- 2
  registry_end_year <- 10
  par(mfrow=c(2,2))
  survival_modelling_diagnostics_current(registry_data, ages = c(55, 65, 75, 85, 100), 
                                         registry_years, registry_start_year, registry_end_year)
}
```

```{r check_survival_modelling_diagnostics_comp, message=T, cache=TRUE}
test_output(survival_modelling_diagnostics_current_output, survival_modelling_diagnostics_dev)
```

Here the output looks different; we seem to have lost a year of survival data. Next we will break the function up into smaller ones to generate each plot individually.

## sim_check

```{r check_sim_check}
sim_check_dev <- function() {
  sim_check(incidence(registry_data$entrydate))
}
```

```{r check_sim_check_current}
sim_check_current_output <- function() {
  sim_check_current(incidence(registry_data$entrydate))
}
```

```{r check_sim_check_comp, message=T, cache=TRUE}
test_output(sim_check_current_output, sim_check_dev)
```

Success was achieved, then seed fixing was removed.

## smoothed_incidence

```{r check_smo}
smo_dev <- function() {
  smoothed_incidence(registry_data$entrydate, start = "2004-01-30", num_years = 9)
}
```

```{r check_smo_current}
smo_current_output <- function() {
  par(mfrow=c(2,2))
  smoothed_incidence_current(registry_data$entrydate, start_date = "2004-01-30", num_years = 9)
}
```

```{r check_smo_comp, message=T, cache=TRUE}
test_output(smo_current_output, smo_dev)
```

Success was achieved. Next we will break the function up into smaller ones to generate each plot individually and unit test again:

```{r check_smo2}
smo_dev2 <- function() {
    par(mfrow=c(2,2))
    c_inc <- cumulative_incidence(registry_data$entrydate, start = "2004-01-30", num_years = 9)
    ordered_diagnoses <- c_inc$ordered_diagnoses
    cum_inc <- c_inc$cumulative_incidence
    smooth <- c_inc$smooth

    plot(ordered_diagnoses, cum_inc, pch=20, 
     cex=0.7, xlab="days", ylab="cumulative diagnoses")
    abline(a=0, b=length(ordered_diagnoses)/ordered_diagnoses[length(ordered_diagnoses)], 
       col="red", lwd=2)
    lines(smooth, col="green", lwd=2)

    plot(ordered_diagnoses, cum_inc - predict(smooth, ordered_diagnoses)$y, 
     type="l", xlab="days", ylab="deviation from smooth")

    inspect_incidence(c_inc)
    poisson_incidence_sim(c_inc)
}
```

```{r check_smo_current2}
smo_current_output2 <- function() {
  par(mfrow=c(2,2))
  smoothed_incidence(registry_data$entrydate, start = "2004-01-30", num_years = 9)
}
```

```{r check_smo_comp2, message=T, cache=TRUE}
test_output(smo_current_output2, smo_dev2)
```