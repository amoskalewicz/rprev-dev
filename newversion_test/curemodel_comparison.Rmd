---
title: "Comparison of v0.3"
output:
    html_notebook:
        toc: true
        toc_float: 
            collapsed: false
---

```{r, echo=F}
library(flexsurvcure)
library(dplyr)
library(ggplot2)
data(prevsim)
```

# Introduction

In the [previous notebook](rprev_newversion.html), I introduced the new parameterisation and backend simulation approach of the new rprev version (v0.3) and provided a small demonstration between the two, suggesting that both methods produce similar estimates. This notebook extends this to include the latest features that I've added, comprising incidence modelling, accepting custom survival models, and the cure model implementation in v0.3, which borrows heavily from the `flexsurvcure` package using mixture models, rather than the custom method used previously.

# Cure model

## Background

A quick introduction to the mixture cure model then. Essentially this model assumes that there is a certain fraction of the population that are cured of the disease, and attempts to model both the survival function of the cured individuals, and also model the probability of being cured.

$S(t|x) = S_{c}(t|x)(1 - \pi(x) + \pi(x)S_{u}(t | x))$

Where $\pi(x)$ is the probability of being **uncured** for a patient with covariates $x$, and is typically modelled as a logistic regression. $S_{u}(t|x)$ is the survival function that will typically come from an appropriate distribution, while $S_{c}(t|x)$ represents the survival function for cured patients, and can be estimated from population mortality tables.

There are also *non-mixture* cure models but I haven't looked into this at all.

## Implementation

The package `flexsurvcure` extends the (already fantastic) `flexsurv` with cure models with a user-friendly API, as shown below. The new arguments here are `link` and `mixture`. `link` specifies the transform to use on $\pi(x)$, while the `mixture` flag indicates whether the model should be a mixture or non-mixture.

```{r}
cure_mod <- flexsurvcure(Surv(time, status) ~ age + sex, data=prevsim, dist='weibull', link='logistic', mixture=TRUE)
```

Before going into the interpretation of the model coefficients, it's important to point out how the these models are parameterised by `flexsurvcure`. By default, the covariates specified on the RHS of the formula are solely acting on $\pi(x)$, and have no effect on the survival function, i.e. modelling

$S(t|x) = S_{c}(t|x)(1 - \pi(x) + \pi(x)S_{u}(t))$

It is possible to specify that covariates should also impact on the survival function but I am not familiar enough with cure models to suggest whether this is always appropriate so for now I've been using the default parameterisation.

The model as displayed below then has the following interpretation:

  - `theta`: The intercept of a logistic regression on whether a patient is **uncured** or not.
  - `sexF`: The effect of sex on the log-odds of a patient being uncured
  - `age`:  The effect of age on the log-odds of a patient being uncured
  - `shape`: The shape of the Weibull distribution giving the survival function of uncured patients. Note that since the package is based on top of `flexsurv` it uses the same distribution parameterisations as the ones in R (i.e. `pweibull`, `rweibull`, ...) rather than the ones used in the `survival` package
  - `scale`: The scale of the Weibull distribution
  
**Note that this is a simulated data set and so a cure model may not be appropriate at all. This is just an example of the implementation**. This shows that elderly patients are more likely to not be cured, while the effect of sex on cure probability is inconclusive.

```{r, echo=F}
cure_mod
```

I personally couldn't follow how the models would be able to fit well if the covariate effects were only placed on the logistic regression so I plotted the Kaplan-Meier (directly below) along with the estimated survival function for an average age male and female from the mixture cure model (below the K-M). The model does seem to fit well, although I'd like to look a little more closely at how the covariate effects are handled.

```{r}
ecsgR::ggkm(survfit(Surv(time, status) ~ sex, prevsim))
```

```{r, echo=F}
cure_surv_probs <- summary(cure_mod, newdata=data.frame(sex=factor(c('F', 'M'), levels=c('F', 'M')), age=mean(prevsim$age)), t=1:4000, tidy=T)
cure_surv_probs$sex <- factor(cure_surv_probs$sex, levels=c('F', 'M'))
ggplot(cure_surv_probs, aes(x=time, y=est, colour=sex)) +
    geom_line() +
    ylim(0, 1) +
    labs(x="Time (days)", y="Survival Probability") +
    ecsgR::theme_Publication() +
    ecsgR::scale_colour_Publication()
```

## Covariate effects on survival function

I'm curious if the location of the covariate effects in the cure model makes a difference on the model's survival estimates. The default parameterisation as shown above has the predictors **solely** affecting the probability of being cured, rather than the survival function itself.

However, upon trying this myself through the use of the `anc` argument, the optimisation won't converge. **I'd like to look more into this, and get feedback from others on whether it's worth trying to get this to work or just stick with the default of covariates acting on $\pi(x)$.**

```{r}
cure_mod_anc <- flexsurvcure(Surv(time, status) ~ age + sex, data=prevsim, dist='weibull', 
                             anc=list(scale=~ age + sex), link='logistic', mixture=TRUE)
```

# Comparison of prevalence estimates

This section provides a quick summary of the new prevalence function, comparing it to the old version using both cure models and not, as well as brief look at using different distributions for the survival function.

## No cure model

The function calls below show that, in my opinion, the new version is cleaner and better separates the prevalence into its 2 constituent stochastic processes.

```{r}
wei_legacy_nocure <- prevalence_legacy(Surv(time, status) ~ age(age) + sex(sex) + entry(entrydate) + event(eventdate),
                                       data=prevsim, num_years_to_estimate = c(5, 10, 20, 50), num_reg_years = 10,
                                       population_size = 1e6, cure = 9999,
                                       index_date = '2013-01-01')
```

The call below also highlights the specification of the default Incidence model (a homogeneous Poisson process) as a formula `inc_formula`. The LHS gives the incident date column name, while the RHS provides any categorical variables to stratify by. In this case we are stratifying incidence by sex, although it is not obligatory to provide a stratification variable, instead passing `entrydate ~ 1`.

```{r}
wei_new_nocure <- prevalence(index='2013-01-01', num_years_to_estimate=c(5, 10, 20, 50), data=prevsim, 
                             inc_formula = entrydate ~ sex,
                             surv_formula = Surv(time, status) ~ age + sex, population_size = 1e6,
                             dist='weibull', death_column = 'eventdate')
```

Prevalence has been estimated over a number of years, using the same Weibull survival model for both with just age and sex as covariates, and a homogeneous Poisson process for incidence stratified by sex. The prevalence estimates are extremely similar, even when simulating 50 years back, suggesting that the new version is well calibrated.

```{r}
wei_legacy_nocure
```

```{r}
wei_new_nocure
```

## With cure model

However, a more interesting comparison is in the prevalence estimates when using a cure model for estimating the survival function. This is no longer just testing a different software implementation of the same mathematical model, but also a different underlying model. The *legacy* cure model adds on the population survival function after a set threshold of years when the patient is deemed to be cured of the disease. This necessitates a priori knowledge of an appropriate cure time. The new method uses the established mixture model, which assumes that the patient population consists of a subset of individuals who are cured and have population mortality. We wouldn't therefore expect these two approaches to provide the same prevalence estimates, although it will be interesting to see how they compare.

**NB: one practical drawback of the mixture cure model is its extremely long fitting time, as I assume it is using EM to fit the latent $\pi(x)$ model. This means the overall prevalence estimation using 1000 simulations is an order of magnitude slower and so for a start could not be used for our website prevalence estimation.**

```{r}
wei_legacy_cure <- prevalence_legacy(Surv(time, status) ~ age(age) + sex(sex) + entry(entrydate) + event(eventdate),
                                     data=prevsim, num_years_to_estimate = c(5, 10, 20, 50), num_reg_years = 10,
                                     population_size = 1e6, cure = 10,
                                     index_date = '2013-01-01')
```

**Note that I had to reduce the number of simulations here to 100, and even then it still took a few minutes.** I'll also explain the `surv_model` argument later.

```{r}
wei_new_cure <- prevalence(index='2013-01-01', num_years_to_estimate=c(5, 10, 20, 50), data=prevsim, 
                             inc_formula = entrydate ~ sex,
                             surv_model = cure_mod, population_size = 1e6,
                             death_column = 'eventdate', N_boot = 100)
```

```{r}
wei_legacy_cure
```

The mixture cure model is more optimistic about the overall survival of cured patients, or predicts a very high proportion will be cured, since the prevalence is significantly higher. Is this difference too large, or can it be justified? I need to read up more on mixture cure models. The prevalence estimate for 50 years for the non-cure model was 1,040 from both the new and legacy functions, so the old cure model method actually gives counter-intuitive results while the new one makes more sense.

```{r}
wei_new_cure
```

## Different distributions

It is now easy to provide different distributions to use for the survival model, below we can see that the Weibull, Log-normal, and Exponential distributions offer a range of prevalence estimates so care must be taken to provide a sensible model.

```{r}
prevalence(index='2013-01-01', num_years_to_estimate=c(10, 20, 50), data=prevsim, 
           inc_formula=entrydate ~ sex,
           surv_formula = Surv(time, status) ~ age + sex, population_size = 1e6,
           dist='weibull', death_column="eventdate")
```

```{r}
prevalence(index='2013-01-01', num_years_to_estimate=c(10, 20, 50), data=prevsim, 
           inc_formula=entrydate ~ sex,
           surv_formula = Surv(time, status) ~ age + sex, population_size = 1e6,
           dist='lognormal', death_column = "eventdate")
```


```{r}
prevalence(index='2013-01-01', num_years_to_estimate=c(10, 20, 50), data=prevsim, 
           inc_formula=entrydate ~ sex,
           surv_formula = Surv(time, status) ~ age + sex, population_size = 1e6,
           dist='exponential', death_column = "eventdate")
```

## Passing in custom survival objects

Specifying the survival model in terms of its formula and distribution uses a custom, optimised implementation of the `survreg` call. I've currently only got it working for the three distributions above, but I hope to extend it to other ones later on.

**However,** users aren't limited to these 3 distributions. I've also added a method for `flexsurvreg` objects, which allows any object created from `flexsurv` to be passed in. This approach is slower than my optimised methods, but for users with specific needs this provides greater flexibility. 

For example, if I want a log-logistic survival model then I can pass one in through the `surv_model` argument instead, as follows.

```{r}
llogis_mod <- flexsurvreg(Surv(time, status) ~ sex + age, data=prevsim, dist='llogis')
llogis_mod
```

This creates the survival object in a familiar way, then it can be directly passed into the `prevalence` call. This allows for the user to do the model selection and diagnostics in their familiar environment and pass the final model directly into `rprev`. This is far slower than the default method, but if the `rprev` step is only run once at the end of the model building stage then this shouldn't be a big drawback given the increased flexibility this option provides. 

Note that I've had to reduce it to 100 simulations to get it to run so I can finish up quickly and go on holiday and this took several minutes. I'll do a formal speed comparison when I get back.

```{r}
prevalence(index='2013-01-01', num_years_to_estimate=c(10, 20, 50), data=prevsim, 
           inc_formula=entrydate ~ sex,
           surv_model=llogis_mod, population_size = 1e6,
           death_column = "eventdate",
           N_boot=100)
```

# Further Work

Areas of further exploration and work include:

Is the mixture cure model plausible, given it predicts significantly more patients will be alive at the index date? Is this difference with the original model justifiable? Also, why is the original cure model estimating lower prevalence than without using a cure model? I imagine there is a certain amount of theoretical justification for mixture cure models as there are several papers dedicated to their use. **It is also important to note that they have been tested on a simulated data set which hasn't been designed to have a cured fraction**. It would be more appropriate to test on real diseases where we do encounter the cured phenomenom. This result also indicates that cure models can't be blindly used without any justification

Does the long runtime of the cure model implementation using `flexsurvcure` render it unsuitable for use? Or just use it with a smaller number of simulations? One option is to provide it with the package as others may find it useful, but not use it for our website estimations. It is relatively common in software development to release a tool in a form that is suitable for general use, but use a more restricted version for internal applications

Small bits:

  - I need to run a full speed comparison to highlight just how slow the cure model is, as well as the difference between the default survival modelling and using `flexsurv` objects
  - Is it worth looking more into having covariate effects on the survival function itself or just on the cure modelling?
  - Get more distributions working with the default optimised `survreg` survival model
  - I need to make unit tests for the new functions