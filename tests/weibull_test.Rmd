---
title: "Testing Weibull Model"
author: "Stuart Lacy"
date: "26 April 2016"
output: 
  html_document: 
    number_sections: yes
    theme: lumen
    toc: yes
    toc_float:
        collapsed: false
    code_folding: show
---

# Introduction

The aim of this script is to better understand the Weibull parameterisation, and how survival probabilities are extracted from it directly using `pweibull`.

# Setup

```{r, message=F, warning=F}
library(dplyr)
library(abind)
library(rms)
library(survival)
library(devtools)
library(knitr)
opts_chunk$set(message=F, warning=F, error=T)
```

Let's firstly build a survival model using this data.

```{r}
registry_data <- readRDS("../data/registry_data.rds")
mod <- survreg(Surv(stime, status) ~ sex + age, data=registry_data, dist='weibull')
mod
```

**NB: That what is called `scale` in the object is actually 1/shape**

```{r}
coefs <- mod$coefficients
scale <- mod$scale
```

# Analysis

In the bootstrapping code, the survival probability is extracted using `pweibull` as follows:

In this example I'm going to predict the survival probability for a 60 year old man at 500 days.

```{r}
pred_st = 1 - pweibull(500, scale=exp(coefs[1] + 0 * coefs[2] + 60 * coefs[3]), shape=1/scale)
pred_st
```

That's a pretty high survival probability!

However there isn't a method in survreg for calculating this so how is it done otherwise?! Since this is an AFT model rather than a PH it seems that it's easier to predict the event time rather than survival probability.

**NB: When using predict, we're predicting on the original scale (i.e. F(t), so ensure that I transform the output again)**
Anyway this produces the same number of days as Simon's method so that's a relief.

```{r}
predict(mod, newdata=list(age=60, sex=0), type='quantile', p=1-pred_st)
```

# Using `flexsurv`

```{r}
library(flexsurv)
```

Let's try using the `flexsurv` package.

```{r}
modflex <- flexsurvreg(Surv(stime, status) ~ sex + age, data=registry_data, dist='weibull')
```

This should make the same model as before.

We can plot the survival curve for a 60 year old male, where we'd expect to see a survival probability of 0.70 at 500 days.

```{r}
plot(modflex, newdata=list(age=60, sex=0))
```

But instead the survival probability at 500 days appears to be far higher. The time with a survival probability of 0.70 looks to be around 3500.

However, the KM estimate appears to be far closer at 500 days to the predicted survival probability of 0.70!

`summary.flexsurvreg` provides a direct calculation of these probabilities.

We can find the survival probability at t=500, luckily this is exactly that returned by Simon's manual method.

```{r}
summary(modflex, newdata=list(age=60, sex=0), t=500)
```

Likewise can find the time when probability is around 0.944.

```{r}
probs <- summary(modflex, newdata=list(age=60, sex=0))[[1]]
probs[probs$est < 0.9445 & probs$est > 0.9435, ]
```

Yep, this is around 500 days.

# Questions

  + Where is the maths that states how `pweibull` and S(t) are related, as a function of covariates?